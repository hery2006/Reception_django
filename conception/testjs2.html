<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>To-Do List Pro</title>
<style>
  body { font-family: Arial; padding: 20px; background: #f9f9f9; }
  h2 { color: #333; }
  #taskInput, #subTaskInput { width: 300px; padding: 5px; }
  button { padding: 5px 10px; margin-left: 5px; cursor: pointer; }
  select { margin-left: 10px; padding: 5px; }
  ul { list-style: none; padding-left: 0; }
  li { background: #fff; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; cursor: grab; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
  li.done { text-decoration: line-through; color: gray; opacity: 0.7; }
  .sub-tasks { margin-left: 20px; padding-left: 10px; border-left: 2px dashed #ccc; }
  .notification { position: fixed; top: 20px; right: 20px; background: #4CAF50; color: #fff; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; }
  .notification.show { opacity: 1; }
</style>
</head>
<body>

<h2>To-Do List Pro</h2>

<input type="text" id="taskInput" placeholder="Nouvelle tâche principale">
<button id="addBtn">Ajouter</button>

<select id="filter">
  <option value="all">Toutes</option>
  <option value="done">Terminées</option>
  <option value="pending">En cours</option>
</select>

<ul id="todo-list"></ul>

<div id="notification" class="notification"></div>

<script>
/* --------- Variables --------- */
let tasks = JSON.parse(localStorage.getItem("tasks")) || [];

/* --------- Sauvegarder dans localStorage --------- */
function saveTasks() {
  localStorage.setItem("tasks", JSON.stringify(tasks));
}

/* --------- Notifications --------- */
function showNotification(msg) {
  const notification = document.getElementById("notification");
  notification.textContent = msg;
  notification.classList.add("show");
  setTimeout(() => notification.classList.remove("show"), 2000);
}

/* --------- Création d'une tâche ou sous-tâche --------- */
function createTaskElement(task) {
  let li = document.createElement("li");
  li.draggable = true;
  li.dataset.id = task.id;
  li.className = task.done ? "done" : "";

  // HTML de la tâche
  li.innerHTML = `<span>${task.text}</span>
                  <div>
                    <button class="toggle">✔️</button>
                    <button class="delete">❌</button>
                    <button class="add-sub">➕ Sous-tâche</button>
                  </div>`;

  // Sous-tâches container
  let subUl = document.createElement("ul");
  subUl.className = "sub-tasks";
  li.appendChild(subUl);

  if(task.subTasks) {
    task.subTasks.forEach(sub => subUl.appendChild(createSubTaskElement(sub, task)));
  }

  // Toggle done
  li.querySelector(".toggle").addEventListener("click", () => {
    task.done = !task.done;
    renderTasks();
    saveTasks();
    showNotification(task.done ? "Tâche terminée" : "Tâche remise en cours");
  });

  // Delete task
  li.querySelector(".delete").addEventListener("click", () => {
    tasks = tasks.filter(t => t.id !== task.id);
    renderTasks();
    saveTasks();
    showNotification("Tâche supprimée");
  });

  // Add sub-task
  li.querySelector(".add-sub").addEventListener("click", () => {
    let subText = prompt("Nom de la sous-tâche:");
    if(!subText) return;
    if(!task.subTasks) task.subTasks = [];
    task.subTasks.push({id: Date.now(), text: subText, done: false});
    renderTasks();
    saveTasks();
    showNotification("Sous-tâche ajoutée");
  });

  // Drag & Drop
  li.addEventListener("dragstart", e => e.dataTransfer.setData("text/plain", task.id));
  li.addEventListener("dragover", e => e.preventDefault());
  li.addEventListener("drop", e => {
    e.preventDefault();
    let draggedId = e.dataTransfer.getData("text");
    let draggedIndex = tasks.findIndex(t => t.id == draggedId);
    let targetIndex = tasks.findIndex(t => t.id == task.id);
    let [draggedTask] = tasks.splice(draggedIndex, 1);
    tasks.splice(targetIndex, 0, draggedTask);
    renderTasks();
    saveTasks();
  });

  return li;
}

/* --------- Sous-tâche --------- */
function createSubTaskElement(subTask, parentTask) {
  let li = document.createElement("li");
  li.dataset.id = subTask.id;
  li.className = subTask.done ? "done" : "";
  li.innerHTML = `<span>${subTask.text}</span>
                  <div>
                    <button class="toggle">✔️</button>
                    <button class="delete">❌</button>
                  </div>`;

  // Toggle done
  li.querySelector(".toggle").addEventListener("click", () => {
    subTask.done = !subTask.done;
    renderTasks();
    saveTasks();
    showNotification(subTask.done ? "Sous-tâche terminée" : "Sous-tâche remise en cours");
  });

  // Delete sub-task
  li.querySelector(".delete").addEventListener("click", () => {
    parentTask.subTasks = parentTask.subTasks.filter(s => s.id !== subTask.id);
    renderTasks();
    saveTasks();
    showNotification("Sous-tâche supprimée");
  });

  return li;
}

/* --------- Rendu des tâches selon filtre --------- */
function renderTasks() {
  let filter = document.getElementById("filter").value;
  let list = document.getElementById("todo-list");
  list.innerHTML = "";
  tasks
    .filter(task => filter === "all" || (filter === "done" && task.done) || (filter === "pending" && !task.done))
    .forEach(task => list.appendChild(createTaskElement(task)));
}

/* --------- Ajouter une tâche principale --------- */
document.getElementById("addBtn").addEventListener("click", () => {
  let input = document.getElementById("taskInput");
  if(input.value.trim() === "") return;
  tasks.push({id: Date.now(), text: input.value.trim(), done: false, subTasks: []});
  input.value = "";
  renderTasks();
  saveTasks();
  showNotification("Tâche ajoutée");
});

/* --------- Filtrer les tâches --------- */
document.getElementById("filter").addEventListener("change", renderTasks);

/* --------- Initial render --------- */
renderTasks();

</script>
</body>
</html>
