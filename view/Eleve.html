{% load static %}
{% load dict_extras %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Élèves</title>
<style>
/* ------------------------
    BASE & RESET
------------------------ */
* {margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI", Tahoma, sans-serif;}
body {background-color:#101820; color:#e0e0e0; padding:20px;}
h1 {text-align:center; margin-bottom:20px; color:#2dd4bf;}

/* ------------------------
    MESSAGES
------------------------ */
.messages {margin-bottom:20px; text-align:center;}
.message {display:inline-block; padding:8px 16px; border-radius:6px; font-weight:500; box-shadow:0 2px 6px rgba(0,0,0,0.4); animation: fadeIn 0.5s ease-in-out; font-size:0.9em;}
.message.success {background-color:#1b3a1b; color:#00ff6a; border-left:4px solid #28a745;}
.message.error {background-color:#3a1b1b; color:#ff4c4c; border-left:4px solid #dc3545;}
.message.info {background-color:#1b2b3a; color:#00d4ff; border-left:4px solid #17a2b8;}
@keyframes fadeIn {from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}

/* ------------------------
    FORMULAIRE AJOUT ÉLÈVE
------------------------ */
.eleve_ajout {background:#1a1f24; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.5); margin-bottom:30px;}
.eleve_ajout h1 {font-size:1.6em; margin-bottom:20px;}
form {display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px;}
label {display:block; font-weight:600; margin-bottom:4px; color:#a0a0a0; font-size:0.9em;}
form input[type="text"], form select, form input[type="file"] {padding:6px 8px; border:1px solid #333; border-radius:5px; width:100%; background:#262b30; color:#e0e0e0; font-size:0.9em;}
form input:focus, form select:focus {border-color:#2dd4bf; box-shadow:0 0 4px rgba(45,212,191,0.5);}
form button {background:#2dd4bf; color:#021012; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; grid-column:1/-1; font-weight:600; font-size:0.95em; transition:0.3s;}
form button:hover {background:#1fa89a;}

/* ------------------------
    TABLEAU LISTE ÉLÈVES
------------------------ */
.table_eleve {background:#1a1f24; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.5);}
.table_eleve h1 {font-size:1.5em; margin-bottom:15px;}
.recherche {margin-bottom:12px; text-align:right;}
.recherche input[type="text"] {padding:6px 10px; border-radius:5px; border:1px solid #333; background:#262b30; color:#e0e0e0; font-size:0.9em; width:200px;}
.recherche button {padding:6px 12px; font-size:0.9em; border:none; border-radius:5px; background:#2dd4bf; color:#021012; cursor:pointer; margin-left:4px; transition:0.3s;}
.recherche button:hover {background:#1fa89a;}

.listage_eleve table {width:100%; border-collapse:collapse; font-size:0.85em;}
.listage_eleve th, .listage_eleve td {padding:6px 8px; text-align:center; border-bottom:1px solid #333;}
.listage_eleve th {background:#262b30; color:#2dd4bf; font-weight:600; font-size:0.85em;}
.listage_eleve tr:nth-child(even) {background:#1f2429;}
.listage_eleve tr:hover {background-color:#2b3137;}

.listage_eleve button {padding:4px 8px; font-size:0.75em; border-radius:4px;}
.listage_eleve button:hover {opacity:0.85;}
.listage_eleve a:nth-child(2) button {background:#17a2b8; color:#fff;}
.listage_eleve a:nth-child(2) button:hover {background:#10707f;}
.listage_eleve a:nth-child(1) button {background:#dc3545; color:#fff;}
.listage_eleve td[colspan="7"] {color:#999; font-style:italic; padding:8px;}

/* FORMATIONS DANS TABLEAU */
.listage_eleve table table {font-size:0.8em; margin:auto;}
.listage_eleve table table th, .listage_eleve table table td {padding:3px 6px;}

/* ÉTATS ACTIF / INACTIF */
.listage_eleve td[style*="background-color:#00ff3c"] {color:#021012; font-weight:600;}
.listage_eleve td[style*="background-color:#ff3300"] {color:#fff; font-weight:600;}
</style>

</head>
<body>

    <section class="eleve_ajout">
        <h1>Ajout d’un élève</h1>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <form action="{% url 'Ajout_html' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div>
                <label for="Nom">Nom :</label>
                <input type="text" placeholder="Nom" name="Nom" id="Nom" required>
            </div>

            <div>
                <label for="Prenom">Prénom :</label>
                <input type="text" placeholder="Prénom" name="Prenom" id="Prenom" required>
            </div>

            <div>
                <label for="Formation">Formation :</label>
                <select name="Formations" id="Formation" required> 
                    <option value="">-- Choisir une formation --</option>
                    {% for f in Formations %}
                        <option value="{{ f.id }}">{{ f.Nom }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="Droit">Droit :</label>
                <select name="Droit" id="Droit">
                    <option value="True">Payer</option>
                    <option value="False">Pas encore payer</option>
                </select>
            </div>

            <div>
                <label for="Dossier">Dossier :</label>
                <select name="Dossier" id="Dossier">
                    <option value="True">Complet</option>
                    <option value="False">Pas encore complet</option>
                </select>
            </div>

            <div>
                <label for="Niveau">Niveau :</label>
                <select name="Niveau" id="Niveau"> 
                    <option value="">-- Choisir un niveau --</option> 
                </select>
            </div>
            <div>
                <label for="Numero">Numero :</label>
                <input type="text" placeholder="Numero de telephone" name="Numero" id="Numero" required>
            </div>
            <div>
                <label for="photo">Photo ou document :</label>
                <input type="file" name="photo" id="photo" accept="image/*,application/pdf">
            </div>

            <button type="submit">Ajouter</button>
        </form>
    </section>

    <section class="table_eleve">
        <h1>Liste des élèves actuels</h1>
        <div class="recherche">
            <form action="{% url 'rechercher' %}" method="post">
                {% csrf_token %}
                <input type="text" name="Recherche_text" placeholder="Recherche une personne">
                <button type="submit"> recherche </button>
            </form>
        </div>
        <div class="listage_eleve">
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Droit</th>
                        <th>Numero</th>
                        <th>Dossier</th>
                        <th>Status</th>
                        <th>Formation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if Eleve %}
                        {% for value in Eleve %}
                            <tr>
                                <td data-label="Nom">{{ value.Nom }}</td>
                                <td data-label="Prénom">{{ value.Prenom }}</td>
                                <td data-label="Droit">{{ value.Droit|yesno:"Payer,Non payer" }}</td>
                                <td>  {{ value.Numero }}  </td>
                                <td data-label="Dossier">{{ value.Dossier|yesno:"Complet,Pas encore complet" }}</td>
                                <td {% if value.Status == True %}
                                    style="background-color: #00ff3c;"
                                    {% else %}
                                    style="background-color: #ff3300;"
                                    {% endif %}> 
                                    {% if value.Status == True %}
                                    Actif
                                    {% else %}
                                    Plus Actif
                                    {% endif %} 
                                </td>
                                <td data-label="Formation"> 
                                    <table>
                                        <thead>
                                            <tr>
                                                <th> Types de Formations</th>
                                                <th> Niveau </th>
                                                <th> Action </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                {% with  valeur_Data=request.session.avoir_le_bon_formations|get_value:value.id  %}
                                                    {% for nom,data_take in valeur_Data.items %}
                                                        <tr>
                                                            <td>{{nom}}</td>
                                                            <td>{{data_take.Niveau}}</td>
                                                            <td>
                                                                <a href="{% url 'See_eleve_urls' value.id data_take.id_formations %}">
                                                                <button>Voir</button>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                {% endwith %}
                                            </tbody>
                                        </table>
                                        <a href="#"><button>Ajouter</button></a>
                                </td>
                                <td data-label="Actions">
                                    <a href="{% url 'Delete_eleve' value.id %}">
                                        <button>Supprimer</button>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7">Liste vide pour le moment</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <script>
        const niveauxParFormation = {
            {% for f in Formations %}
                "{{ f.id }}": [
                    {% for n in f.niveau_par_formations_set.all %}
                        {"id": "{{ n.id }}", "nom": "{{ n.Niveaux }}"}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        const selectFormation = document.getElementById('Formation');
        const selectNiveau = document.getElementById('Niveau');

        selectFormation.addEventListener('change', function() {
            const formationId = this.value;
            const niveaux = niveauxParFormation[formationId] || [];
            selectNiveau.innerHTML = '<option value="">-- Choisir un niveau --</option>';
            niveaux.forEach(n => {
                const option = document.createElement('option');
                option.value = n.nom;
                option.textContent = n.nom;
                selectNiveau.appendChild(option);
            });
        });
    </script>
</body>
</html>
